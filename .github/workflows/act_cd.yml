name: Continuous Deployment ACT

on:
  push:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: prod-deploy
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      tag: ${{ steps.t.outputs.tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - id: t
        run: echo "tag=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.G_TOKEN }}

      - name: Build & push backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: ghcr.io/dispelk9/analytical_tools_backend:${{ steps.t.outputs.tag }}

      - name: Build & push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/dispelk9/analytical_tools_frontend:${{ steps.t.outputs.tag }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production
    permissions:
      contents: read
      packages: read
    timeout-minutes: 15

    steps:
      - name: Checkout deploy folder only
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          sparse-checkout: |
            deploy/
          sparse-checkout-cone-mode: false

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Pin server host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.IP }}" >> ~/.ssh/known_hosts

      - name: Copy compose file and refresh nginx conf to server
        run: |
          ssh "${{ secrets.SERVER_USER }}@${{ secrets.IP }}" "mkdir -p ~/app ~/app/deploy"
          scp -p deploy/docker-compose.yml \
            "${{ secrets.SERVER_USER }}@${{ secrets.IP }}:~/app/docker-compose.yml"
          scp -p deploy/nginx-proxy/nginx-act.conf \
            "${{ secrets.SERVER_USER }}@${{ secrets.IP }}:/etc/nginx/sites-available/nginx-act.conf"
          scp -p deploy/handbook-sync.sh \
            "${{ secrets.SERVER_USER }}@${{ secrets.IP }}:~/app/deploy/handbook-sync.sh"
          ssh "${{ secrets.SERVER_USER }}@${{ secrets.IP }}" "sudo nginx -t && sudo systemctl reload nginx"

 
      - name: Stage env + deploy on server
        env:
          TAG: ${{ needs.build-and-push.outputs.tag }}

          GHCR_USER: ${{ github.actor }}
          GHCR_TOKEN: ${{ secrets.G_TOKEN }}

          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          SENDER: ${{ secrets.SENDER }}
          MAIL_PW: ${{ secrets.MAIL_PW }}
          SMTP_RELAY: ${{ secrets.SMTP_RELAY }}

        run: |
          set -euo pipefail

          tmpdir="$(mktemp -d)"
          trap 'rm -rf "$tmpdir"' EXIT

          umask 177

          # secret file for docker-compose secret
          cat > "$tmpdir/gemini_api_key" <<EOF
          ${GEMINI_API_KEY}
          EOF

          # backend env_file (backend/.env)
          cat > "$tmpdir/backend.env" <<EOF
          DB_USERNAME=${DB_USERNAME}
          DB_PASSWORD=${DB_PASSWORD}
          DB_HOST=${DB_HOST}
          DB_PORT=${DB_PORT}
          DB_NAME=${DB_NAME}
          SESSION_SECRET=${SESSION_SECRET}
          SENDER=${SENDER}
          MAIL_PW=${MAIL_PW}
          SMTP_RELAY=${SMTP_RELAY}
          GEMINI_MODEL=gemini-2.5-flash-lite
          EOF

          # compose parse-time env (.env next to docker-compose.yml)
          cat > "$tmpdir/compose.env" <<EOF
          DB_PASSWORD=${DB_PASSWORD}
          TAG=${TAG}

          EOF


          ssh "${{ secrets.SERVER_USER }}@${{ secrets.IP }}" "mkdir -p ~/app/backend ~/app/secrets"

          scp -p "$tmpdir/gemini_api_key" \
            "${{ secrets.SERVER_USER }}@${{ secrets.IP }}:~/app/secrets/gemini_api_key"
          scp -p "$tmpdir/backend.env" \
            "${{ secrets.SERVER_USER }}@${{ secrets.IP }}:~/app/backend/.env"
          scp -p "$tmpdir/compose.env" \
            "${{ secrets.SERVER_USER }}@${{ secrets.IP }}:~/app/.env"

          cat <<EOF | ssh "${{ secrets.SERVER_USER }}@${{ secrets.IP }}" "docker login ghcr.io --username '$GHCR_USER' --password-stdin"
          ${GHCR_TOKEN}
          EOF

          ssh "${{ secrets.SERVER_USER }}@${{ secrets.IP }}" bash -lc '
            set -euo pipefail
            cd ~/app
            docker compose pull
            docker compose up -d --remove-orphans --force-recreate
            docker compose ps
          '


name: Continuous Deployment ACT

on:
  push:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: prod-deploy
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      tag: ${{ steps.t.outputs.tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - id: t
        run: echo "tag=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.G_TOKEN }}

      - name: Build & push backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: ghcr.io/dispelk9/analytical_tools_backend:${{ steps.t.outputs.tag }}

      - name: Build & push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/dispelk9/analytical_tools_frontend:${{ steps.t.outputs.tag }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production
    permissions:
      contents: read
      packages: read
    timeout-minutes: 15

    steps:
      - name: Checkout deploy folder only
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          sparse-checkout: |
            deploy/
          sparse-checkout-cone-mode: false

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Pin server host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.IP }}" >> ~/.ssh/known_hosts

      - name: Copy compose file to server
        run: |
          ssh "${{ secrets.SERVER_USER }}@${{ secrets.IP }}" "mkdir -p ~/app"
          scp -p deploy/docker-compose.yml \
            "${{ secrets.SERVER_USER }}@${{ secrets.IP }}:~/app/docker-compose.yml"

 
      - name: Stage env + deploy on server (printf only)
        env:
          TAG: ${{ needs.build-and-push.outputs.tag }}

          GHCR_USER: ${{ github.actor }}
          GHCR_TOKEN: ${{ secrets.G_TOKEN }}

          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          SENDER: ${{ secrets.SENDER }}
          MAIL_PW: ${{ secrets.MAIL_PW }}
          SMTP_RELAY: ${{ secrets.SMTP_RELAY }}

        run: |
          ssh "${{ secrets.SERVER_USER }}@${{ secrets.IP }}" bash -lc '
            set -euo pipefail

            mkdir -p ~/app/backend ~/app/secrets
            umask 177

            # secret file for docker-compose secret
            printf "%s" "$GEMINI_API_KEY" > ~/app/secrets/gemini_api_key

            # backend env_file (backend/.env)
            printf "DB_USERNAME=%s\n" "$DB_USERNAME" >  ~/app/backend/.env
            printf "DB_PASSWORD=%s\n" "$DB_PASSWORD" >> ~/app/backend/.env
            printf "DB_HOST=%s\n"     "$DB_HOST"     >> ~/app/backend/.env
            printf "DB_PORT=%s\n"     "$DB_PORT"     >> ~/app/backend/.env
            printf "DB_NAME=%s\n"     "$DB_NAME"     >> ~/app/backend/.env
            printf "SESSION_SECRET=%s\n" "$SESSION_SECRET" >> ~/app/backend/.env
            printf "SENDER=%s\n"      "$SENDER"      >> ~/app/backend/.env
            printf "MAIL_PW=%s\n"     "$MAIL_PW"     >> ~/app/backend/.env
            printf "SMTP_RELAY=%s\n"  "$SMTP_RELAY"  >> ~/app/backend/.env

            # compose parse-time env (.env next to docker-compose.yml)
            printf "DB_PASSWORD=%s\n" "$DB_PASSWORD" >  ~/app/.env
            printf "TAG=%s\n"         "$TAG"         >> ~/app/.env

            # login to GHCR (if images are private)
            echo "$GHCR_TOKEN" | docker login ghcr.io --username "$GHCR_USER" --password-stdin

            cd ~/app
            docker compose pull
            docker compose up -d --remove-orphans --force-recreate
            docker compose ps
          '



